<!DOCTYPE html>
<html>

<head>
    <style>
    img,
    form,
    head,
    body {
        text-align: center;
    }
    </style>
    <script>
    //preload the six images first
    var face0 = new Image()
    face0.src = "images/d1.gif"
    var face1 = new Image()
    face1.src = "images/d2.gif"
    var face2 = new Image()
    face2.src = "images/d3.gif"
    var face3 = new Image()
    face3.src = "images/d4.gif"
    var face4 = new Image()
    face4.src = "images/d5.gif"
    var face5 = new Image()
    face5.src = "images/d6.gif"
    </script>
    <img src="images/d1.gif" name="mydice">
    <form>
        <input type="button" value="Throw dice!" onClick="throwdice()">
    </form>
    <script>
    var nums = [1, 4, 2, 3, 1, 5, 6, 5, 2, 6, 1];
    var count = 0;

    //get session id
    var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var stringLength = 5;
    var sessionID = Array.apply(null, new Array(stringLength)).map(function() {
        return possible[Math.floor(Math.random() * possible.length)];
    }).join('');

    var die_data = "";

    function throwdice() {
        var randomdice;
        var currentTime = timestamp();
        //create a random integer between 0 and 5
        if (count < 9) {
            randomdice = nums[count + 1];
        } else {
            randomdice = nums[count % 10];
        }

        count++;

        /*
        timeTracking[timestamp()] = {
            "Count": count,
            "die number": randomdice
        };
        */

        die_data = "die_10.html," + sessionID + "," + currentTime + "," + randomdice.toString() + "," + count.toString();
        recordIPAddressData();


        // printLocalStorage();
        document.images["mydice"].src = "images/animated-dice-image.gif";
        document.images["mydice"].style.height = '50px';
        document.images["mydice"].style.width = '50px';

        setTimeout(function() {
            document.images["mydice"].src = "images/die_" + randomdice.toString() + ".png";
        }, 1000);

    }

    function timestamp() {
        var d = new Date();
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var days = ['Mon', 'Tue', 'Wed', 'Thurs', 'Fri', 'Sat', 'Sun'];
        var day = days[d.getDay()];
        var hr = d.getHours();
        var min = d.getMinutes();
        if (min < 10) {
            min = "0" + min;
        }
        var ampm = hr < 12 ? "am" : "pm";
        var date = d.getDate();
        var month = months[d.getMonth()];
        var year = d.getFullYear();
        var seconds = d.getSeconds();
        var timestamp = day + " " + hr + ":" + min + ":" + seconds + ampm + " " + date + " " + month + " " + year;
        return timestamp;
    }

    function recordIPAddressData() {
        $.getJSON('https://api.ipify.org?format=json', function(data) {

            /*
            var jsonData = JSON.stringify({
                data,
                timeTracking
            });
            */

            //localStorage.setItem(jsonData);
            die_data = data["ip"] + "," + die_data;
            sendDataToBackend(die_data);
            //console.log(data["ip"]);
        });

    }


    function printLocalStorage() {
        for (var key in localStorage) {
            console.log(key + ":" + localStorage[key]);
        }
    }

    function clearLocalStorage() {
        localStorage.clear();
    }

    function sendDataToBackend(jsonData) {
        console.log(jsonData);
        $.ajax({
            type: 'GET', // added,
            url: '/sendDataToBackend',
            data: jsonData,
            contentType: "application/json; charset=utf-8",
            //jsonpCallback: 'callback' - removed
            success: function(data) {
                console.log("success on client side");
            }
        });

    }
    </script>
</head>

</html>
